
test_name: Verify Listeners

includes:
  - !include includes/auth_stage.yaml

stages:
  - type: ref
    id: login_get_token

  - name: Verify listener types are returned
    request:
      verify: false
      url: http://localhost:1337/api/listeners/types
      method: GET
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200
      body: {'types': ['http_hop', 'http_foreign', 'redirector', 'http_com', 'meterpreter', 'onedrive', 'http', 'dbx', 'http_mapi']}

  - name: Verify listener options http
    request:
      verify: false
      url: http://localhost:1337/api/listeners/options/http
      method: GET
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200
      body: !include includes/listener_options_response.json

  - name: Verify start http listener
    request:
      json: !include includes/listener_start_request.json
      verify: false
      url: http://localhost:1337/api/listeners/http
      method: POST
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 201
      body: !include includes/listener_start_response.json

  - name: Verify get listener
    request:
      verify: false
      url: http://localhost:1337/api/listeners/listenerOne # todo var
      method: GET
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200
      body: !include includes/listener_start_response.json

  - name: Verify get all listeners
    request:
      verify: false
      url: http://localhost:1337/api/listeners/
      method: GET
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200
      body: { "listeners": !anylist }

  - name: Verify delete listener
    request:
      verify: false
      url: http://localhost:1337/api/listeners/listenerOne # todo var
      method: DELETE
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 204
