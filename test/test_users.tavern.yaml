test_name: Verify Users Endpoints

includes:
  - !include includes/auth_stage.yaml

stages:
  - type: ref
    id: login_get_token
  - name: Verify /me
    request:
      verify: false
      url: http://localhost:1337/api/users/me
      method: GET
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200
      json: {
        "admin": true,
        "enabled": true,
        "id": 1,
        "lastLogonTime": !anystr ,
          "username": "empireadmin",
        "apiToken": "{test_login_token}"
      }

  - name: Verify Create User
    request:
      json:
        username: "user1"
        password: "password"
      verify: false
      url: http://localhost:1337/api/users/
      method: POST
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 201
      json: {
        "admin": false,
        "enabled": true,
        "id": 2,
        "lastLogonTime": !anystr ,
          "username": "user1"
      }

  - name: Verify Get Users
    request:
      verify: false
      url: http://localhost:1337/api/users/
      method: GET
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200
      json: !include includes/users_response.json
      # redo as { users: [] }

  - name: Verify Get User by Id
    request:
      verify: false
      url: http://localhost:1337/api/users/2
      method: GET
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200
      json: {
        "admin": false,
        "enabled": true,
        "id": 2,
        "lastLogonTime": !anystr ,
          "username": "user1"
      }

  - name: Verify Disable User
    request:
      json:
        disable: true
      verify: false
      url: http://localhost:1337/api/users/2/disable
      method: PUT
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200

  - name: Verify Disabled User
    request:
      verify: false
      url: http://localhost:1337/api/users/2
      method: GET
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      strict:
        - json:off
      status_code: 200
      json:
        enabled: false

  - name: Verify Enable User
    request:
      json:
        disable: false
      verify: false
      url: http://localhost:1337/api/users/2/disable
      method: PUT
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200

  - name: Verify Enabled User
    request:
      verify: false
      url: http://localhost:1337/api/users/2
      method: GET
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      strict:
        - json:off
      status_code: 200
      json:
        enabled: true

  - name: Verify Password Change
    request:
      json:
        password: "new_password"
      verify: false
      url: http://localhost:1337/api/users/2/password
      method: PUT
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200

  - name: Attempt login with new password
    request:
      json:
        username: "user1"
        password: "new_password" # todo use saved var?
      verify: false
      url: http://localhost:1337/api/users/login
      method: POST
      headers:
        content-type: application/json
    response:
      status_code: 200

  - name: Attempt logout
    request:
      verify: false
      url: http://localhost:1337/api/users/logout
      method: POST
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 200

  - name: Verify logout
    request:
      verify: false
      url: http://localhost:1337/api/users/
      method: GET
      headers:
        content-type: application/json
        x-api-key: "{test_login_token}"
    response:
      status_code: 401
